<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ella & Raye's Collection</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    
    <style>
        body {
            background-image: url('bg.jpeg');
            background-repeat: repeat;
            background-size: contain;
            color: white;
            font-family: 'Fredoka One', cursive;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            user-select: none; /* Prevents text selection during long press */
            -webkit-user-select: none;
        }

        h1 { margin-top: 20px; font-size: 28px; color: #ff4d6d; text-shadow: 2px 2px 0px #fff; }

        .main-container {
            display: grid;
            grid-template-columns: 1fr 70px 1fr; 
            gap: 12px;
            width: 95%;
            max-width: 600px;
            margin-top: 10px;
        }

        .column { display: flex; flex-direction: column; gap: 15px; }

        .name-label {
            text-align: center;
            font-size: 20px;
            background: #fff;
            color: #ff4d6d;
            padding: 8px;
            border-radius: 15px;
            box-shadow: 0 4px 0px #ffb3c1;
        }

        .photo-box {
            width: 100%;
            aspect-ratio: 1 / 1;
            background: rgba(255, 255, 255, 0.2);
            border: 3px dashed #fff;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            overflow: hidden;
            position: relative;
        }

        .photo-box img { width: 100%; height: 100%; object-fit: cover; border-radius: 8px; }

        .delete-btn {
            position: absolute; top: 5px; right: 5px;
            background: #ff4d6d; color: white;
            border: 2px solid white; border-radius: 50%;
            width: 25px; height: 25px;
            display: flex; align-items: center; justify-content: center;
            font-size: 14px; font-weight: bold; z-index: 10;
        }

        /* Reactions showing on the small boxes */
        .reactions-preview {
            position: absolute; bottom: 5px; left: 5px;
            display: flex; gap: 2px; font-size: 14px;
        }

        /* --- VIEWER MODAL --- */
        #viewer {
            display: none;
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            flex-direction: column;
            align-items: center; justify-content: center;
        }

        #viewer img { max-width: 90%; max-height: 70%; border: 5px solid white; border-radius: 15px; }

        .reaction-bar {
            margin-top: 20px;
            display: flex; gap: 20px;
            background: white; padding: 10px 20px;
            border-radius: 30px;
        }

        .react-btn { font-size: 30px; cursor: pointer; transition: transform 0.2s; }
        .react-btn:active { transform: scale(1.4); }

        .close-viewer { position: absolute; top: 20px; right: 20px; font-size: 30px; color: white; cursor: pointer; }

        .plus-icon { font-size: 40px; color: white; opacity: 0.8; }
        .gif-column { display: flex; flex-direction: column; align-items: center; }
        .center-gif { width: 60px; position: sticky; top: 50px; }
        #fileInput { display: none; }
    </style>
</head>
<body>

    <h1>‚ú®Collections‚ú®</h1>
    <input type="file" id="fileInput" accept="image/*">

    <div class="main-container">
        <div class="column" id="ella-col"></div>
        <div class="gif-column"><img src="cat.gif" class="center-gif"></div>
        <div class="column" id="raye-col"></div>
    </div>

    <div id="viewer">
        <span class="close-viewer" onclick="closeViewer()">√ó</span>
        <img id="viewer-img" src="">
        <div class="reaction-bar">
            <span class="react-btn" onclick="addReaction('‚ù§Ô∏è')">‚ù§Ô∏è</span>
            <span class="react-btn" onclick="addReaction('üòÇ')">üòÇ</span>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCAvI-nQQhQupedGz0WWo1HkJeWAidUAfk",
            authDomain: "photobooth-8c993.firebaseapp.com",
            databaseURL: "https://photobooth-8c993-default-rtdb.asia-southeast1.firebasedatabase.app", 
            projectId: "photobooth-8c993",
            storageBucket: "photobooth-8c993.firebasestorage.app",
            messagingSenderId: "988328424846",
            appId: "1:988328424846:web:d82e4c1ef79bfab466e0df"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let currentTarget = '';
        let activePhotoId = '';
        let longPressTimer;

        function triggerUpload(person) {
            currentTarget = person;
            document.getElementById('fileInput').click();
        }

        function deletePhoto(e, photoId) {
            e.stopPropagation(); // Stop viewer from opening
            if(confirm("Delete this photo?")) {
                db.ref('shared_collection/' + photoId).remove();
            }
        }

        // --- LONG PRESS & VIEW LOGIC ---
        function handleStart(id, imgSrc) {
            longPressTimer = setTimeout(() => {
                openViewer(id, imgSrc);
            }, 600); // 0.6 seconds long press
        }

        function handleEnd() {
            clearTimeout(longPressTimer);
        }

        function openViewer(id, imgSrc) {
            activePhotoId = id;
            document.getElementById('viewer-img').src = imgSrc;
            document.getElementById('viewer').style.display = 'flex';
        }

        function closeViewer() {
            document.getElementById('viewer').style.display = 'none';
        }

        function addReaction(emoji) {
            if (!activePhotoId) return;
            const ref = db.ref(`shared_collection/${activePhotoId}/reactions`);
            ref.push(emoji);
        }

        // --- UPLOAD LOGIC ---
        document.getElementById('fileInput').onchange = function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.src = event.target.result;
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 600;
                    let width = img.width, height = img.height;
                    if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                    canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    db.ref('shared_collection').push({
                        image: canvas.toDataURL('image/jpeg', 0.7),
                        owner: currentTarget,
                        timestamp: Date.now()
                    });
                };
            };
            reader.readAsDataURL(file);
        };

        // --- RENDER LOGIC ---
        db.ref('shared_collection').on('value', (snap) => {
            const data = snap.val() || {};
            renderPhotos('ella', document.getElementById('ella-col'), data);
            renderPhotos('raye', document.getElementById('raye-col'), data);
        });

        function renderPhotos(name, container, data) {
            container.innerHTML = `<div class="name-label">${name.charAt(0).toUpperCase() + name.slice(1)}</div>`;
            
            const photoList = Object.keys(data).map(key => ({
                id: key, ...data[key]
            })).filter(p => p.owner === name);
            
            photoList.forEach(p => {
                const div = document.createElement('div');
                div.className = "photo-box";
                
                // Reaction preview logic
                let reactHtml = '';
                if(p.reactions) {
                    const lastTwo = Object.values(p.reactions).slice(-2);
                    reactHtml = `<div class="reactions-preview">${lastTwo.join('')}</div>`;
                }

                div.innerHTML = `
                    <div class="delete-btn" onclick="deletePhoto(event, '${p.id}')">X</div>
                    <img src="${p.image}">
                    ${reactHtml}
                `;

                // Long Press Events
                div.onmousedown = () => handleStart(p.id, p.image);
                div.onmouseup = handleEnd;
                div.ontouchstart = () => handleStart(p.id, p.image);
                div.ontouchend = handleEnd;

                container.appendChild(div);
            });

            // Add Plus Box
            const empty = document.createElement('div');
            empty.className = "photo-box";
            empty.innerHTML = `<span class="plus-icon">+</span>`;
            empty.onclick = () => triggerUpload(name);
            container.appendChild(empty);
        }
    </script>
</body>
</html>
